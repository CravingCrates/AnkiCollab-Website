<!DOCTYPE html>
<html lang="en">
  <head>
    {% include "header_template.html" %}
    <script src="/static/plugins/jquery/jquery.min.js"></script>
    <link href="/static/css/commit_styling.css" rel="stylesheet">
    <script>
        // Global namespace for our app
        window.HtmlDiffUtils = {};
        window.ImageHandler = {};
        window.EditorControls = {};
        window.ApiService = {};
        window.SharedUI = {};
    </script>
    <script src="/static/js/html_diff_utils.js"></script>
    <script src="/static/js/image_handling.js"></script>
    <script src="/static/js/editor_controls.js"></script>
    <script src="/static/js/api_service.js"></script>
    <script src="/static/js/shared_ui.js"></script>
  </head>
  {% include "layout_header.html" %}
        <!-- End Top layout-->

        <!-- row -->
        <div class="container-fluid">
            <div class="card">
                <div class="card-body">
                    <div class="text-center mb-3">
                        <h1 class="card-title">Review Note</h1>
                        <p class="text-muted">Last Update: {{ note.last_update }}</p>
                        <p><strong>Current Deck:</strong> {{ note.deck | escape }}</p>
                        <span
                          class="label label-pill {% if note.reviewed and not note.delete_req %}label-info {% elif note.delete_req %}label-danger {% else %}label-success {% endif %}px-4 py-2"
                        >
                          {% if note.reviewed and not note.delete_req %}Published
                          {% elif note.delete_req %}Removal Requested
                          {% else %}New Card (Unpublished)
                          {% endif %}
                        </span>
                      </div>
                      <div class="text-right">
                        {% if access and note.reviewed == false %}
                        <a href="/AcceptNote/{{note.id}}" class="btn mb-1 btn-sm btn-success" title="Publish New Note">
                            <i class="fa fa-check"></i> Publish
                        </a>
                        <a href="/DeleteNote/{{note.id}}" class="btn mb-1 btn-sm btn-danger" title="Delete Unpublished Note">
                            <i class="fa fa-trash"></i> Delete
                        </a>
                        {% elif access and note.delete_req %}
                        <a href="/AcceptNoteRemoval/{{note.id}}" class="btn mb-1 btn-sm btn-danger" title="Confirm Note Deletion">
                            <i class="fa fa-trash"></i> Delete Note
                        </a>
                        <a href="/DenyNoteRemoval/{{note.id}}" class="btn mb-1 btn-sm btn-warning" title="Cancel Removal Request">
                            <i class="fa fa-undo"></i> Keep Note
                        </a>
                        {% endif %}
                      </div>
                </div>
            </div>
          <div class="card note-context" id="{{ note.id }}" data-context-type="note">
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  {% if note.reviewed_fields %}
                    <div>
                      <h4 class="text-center text-muted mb-3">Currently Published Content</h4>
                      <hr>
                      {% for field in note.reviewed_fields %}
                        <div class="media media-reply mb-4">
                          <div class="media-body">
                              <h5 class="mb-2">{{ note.note_model_fields[field.position] }}</h5>
                              <div class="note-content-display current-content"
                                   data-field-id="{{field.id}}" {# Assuming reviewed fields have IDs #}
                                   data-content="{{ field.content | escape }}">
                                  <!-- Content populated by JS -->
                              </div>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  {% else %}
                    <p class="text-muted text-center">No published fields.</p>
                  {% endif %}
                  {% if note.reviewed_tags %}
                    <hr />
                    <div>
                      <div class="mb-2">
                        <h4>Current Tags:</h4>
                        {% if note.reviewed_tags|length > 3 %}
                          <button
                            class="btn mb-1 btn-flat btn-info btn-sm"
                            onclick="toggleTags(this)"
                          >
                              +{{note.reviewed_tags|length - 3}} more
                          </button>
                        {% endif %}
                      </div>
                      <div class="note_tags_container mb-3">
                        {% for tag in note.reviewed_tags|slice(end=3) %}
                        <span class="badge badge-light mr-1 mb-1">{{tag.content}}</span>
                        {% endfor %} {% if note.reviewed_tags|length > 3 %}
                        <div id="collapsedTags" style="display: none">
                          {% for tag in note.reviewed_tags|slice(start=3) %}
                          <span class="badge badge-light mr-1 mb-1">{{tag.content}}</span>
                          {% endfor %}
                        </div>
                        {% endif %}
                      </div>
                    </div>
                  {% else %}
                    <p class="text-muted">No published tags.</p>
                  {% endif %}
                </div>

                <div class="col-md-6 suggestion-side">
                  <h4 class="text-center text-info mb-3">Pending Suggestions</h4>
                  <hr>
                  {% if note.note_move_decks %}
                    <div class="mb-4">
                        <h5 class="mb-2">Deck Move Suggestions:</h5>
                        {% for req in note.note_move_decks %}
                        <div class="note_tag_container suggestion-box">
                            <button class="btn mb-1 btn-flat w-100" disabled>{{req.path}}</button>
                            {% if access %}
                            <div class="tag_actions">
                                <button class="tag_accept_button" role="button" title="Accept Move" data-action="accept-move" data-move-id="{{req.id}}">
                                    <i class="fa fa-check"></i>
                                </button>
                                <button class="tag_deny_button" role="button" title="Deny Move" data-action="deny-move" data-move-id="{{req.id}}">
                                    <i class="fa fa-times"></i>
                                </button>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                  {% endif %}
                  {% if note.unconfirmed_fields %}
                        <h5 class="mb-2">Field Change Suggestions:</h5>
                        {% for field_suggestion in note.unconfirmed_fields %}
                        <div class="media media-reply mb-4 suggestion-box">
                            <div class="media-body">
                                <div class="d-sm-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <h5 class="mb-sm-0 d-inline-block">{{note.note_model_fields[field_suggestion.position]}}</h5>
                                        <a href="/commit/{{ field_suggestion.commit_id }}" class="small text-muted ml-2" title="View Source Commit">
                                            <i class="fa fa-link"></i> Commit #{{ field_suggestion.commit_id }}
                                        </a>
                                    </div>
                                    {% if access and note.reviewed %}
                                    <div class="media-reply__link small-badge field-actions">
                                        <span class="badge badge-pill badge-success mr-1">
                                            <button data-action="accept-field" data-field-id="{{field_suggestion.id}}" class="btn btn-xs btn-approve" title="Accept Change">
                                                <span class="fa fa-check"></span> Accept
                                            </button>
                                        </span>
                                        <span class="badge badge-pill badge-danger">
                                            <button data-action="deny-field" data-field-id="{{field_suggestion.id}}" class="btn btn-xs btn-deny" title="Deny Change">
                                                <span class="fa fa-close"></span> Deny
                                            </button>
                                        </span>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="note-content-display diff-content"
                                    data-field-id="{{ field_suggestion.id }}"
                                    data-original="{{ note.reviewed_fields[field_suggestion.position].content | escape }}"
                                    data-new-content="{{ field_suggestion.content | escape }}">
                                    {{ field_suggestion.diff | safe }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                  {% endif %}
                  {% if note.new_tags or note.removed_tags %}
                        <h5 class="mb-2">Tag Change Suggestions:</h5>
                        {# New Tags #}
                        {% for tag in note.new_tags %}
                        <div class="note_tag_container suggestion-box new-tag-suggestion">
                            <button class="btn mb-1 btn-flat btn-new-tag w-100" disabled>{{tag.content}}</button>
                            {% if access and note.reviewed %}
                            <div class="tag_actions">
                                <button class="tag_accept_button" role="button" title="Accept Tag Addition" data-action="accept-tag" data-tag-id="{{tag.id}}">
                                    <i class="fa fa-check"></i>
                                </button>
                                <button class="tag_deny_button" role="button" title="Deny Tag Addition" data-action="deny-tag" data-tag-id="{{tag.id}}">
                                    <i class="fa fa-times"></i>
                                </button>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                        {# Removed Tags #}
                        {% for tag in note.removed_tags %}
                        <div class="note_tag_container suggestion-box removed-tag-suggestion">
                            <button class="btn mb-1 btn-flat btn-rmd-tag w-100" disabled>{{tag.content}}</button>
                            {% if access and note.reviewed %}
                            <div class="tag_actions">
                                <button class="tag_accept_button" role="button" title="Accept Tag Removal" data-action="accept-tag" data-tag-id="{{tag.id}}">
                                    <i class="fa fa-check"></i>
                                </button>
                                <button class="tag_deny_button" role="button" title="Deny Tag Removal" data-action="deny-tag" data-tag-id="{{tag.id}}">
                                    <i class="fa fa-times"></i>
                                </button>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                  {% endif %}

                  {# Handle case where there are no suggestions at all #}
                  {% if not note.note_move_decks and not note.unconfirmed_fields and not note.new_tags and not note.removed_tags %}
                    <p class="text-muted text-center mt-4">No pending suggestions for this note.</p>
                  {% endif %}
                </div>
                <!-- end col -->
              </div>
              <!-- end row -->
            </div>
            <!-- end card-body -->
          </div>
          <!-- end card -->
        </div>
        <!-- end container-fluid -->
      </div>
      <!--**********************************
            Content body end
        ***********************************-->
        {% include "layout_footer.html" %}

        <script>
          function toggleTags(button) {
            var collapsedTags = document.getElementById("collapsedTags");
            if (collapsedTags.style.display === "none") {
              collapsedTags.style.display = "block";
              button.innerHTML = "Show less";
            } else {
              collapsedTags.style.display = "none";
              button.innerHTML = "+{{note.reviewed_tags|length - 3}} more";
            }
          }

          // Initialize the shared UI components after the page loads
          $(document).ready(function() {
              SharedUI.initializePage();
          });
        </script>
  </body>
</html>