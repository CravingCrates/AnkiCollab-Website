<!DOCTYPE html>
<html lang="en">
<head>
    {% include "header_template.html" %}
    <title>Review Note</title>
    
    <!-- Custom Stylesheet -->
    <link href="/static/plugins/trumbowyg/ui/trumbowyg.css" rel="stylesheet">
    <link href="/static/plugins/trumbowyg/plugins/colors/ui/trumbowyg.colors.css" rel="stylesheet">
    <link href="/static/css/commit_styling.css" rel="stylesheet">
    <link href="/static/css/review.css" rel="stylesheet">
    <script src="/static/plugins/jquery/jquery.min.js"></script>
    <script src="/static/js/html_diff_utils.js"></script>
    <script src="/static/js/image_handling.js"></script>
    <script src="/static/js/api_service.js"></script>
    <script src="/static/js/shared_ui.js"></script>
</head>
{% include "layout_header.html" %}

<body>
    <div class="main-container">
        <div class="container-fluid">
            
            {% if note.is_inherited %}
            <div class="inherited-alert">
                <i class="fa fa-link" aria-hidden="true"></i>
                <div>
                    <strong>Inherited Content:</strong> This note inherits content from a base note. Protected fields remain local. Tags are managed locally.
                </div>
            </div>
            {% endif %}
            
            <div class="page-header">
                <div class="header-content">
                    <div class="header-grid">
                        <div class="header-primary">
                            <div class="header-top">
                                <h1 class="header-title">Review Note</h1>
                                <span class="status-badge {% if note.reviewed and not note.delete_req %}status-published{% elif note.delete_req %}status-removal{% else %}status-pending{% endif %}">
                                    {% if note.reviewed and not note.delete_req %}
                                        <i class="fa fa-check-circle"></i>
                                        <span>Published</span>
                                    {% elif note.delete_req %}
                                        <i class="fa fa-exclamation-triangle"></i>
                                        <span>Removal Requested</span>
                                    {% else %}
                                        <i class="fa fa-clock-o"></i>
                                        <span>New Card (Unpublished)</span>
                                    {% endif %}
                                </span>
                            </div>
                            <p class="header-subtitle">
                                <strong>Deck:</strong> {{ note.deck }}<br><strong>Last Update:</strong> {{ note.last_update }}
                            </p>
                        </div>
                        <div class="header-actions action-buttons">
                            <a href="/note_history/{{note.id}}" class="modern-action-btn btn-history" title="View full history">
                                <i class="fa fa-history"></i>
                                History
                            </a>
                            
                            {% if access and note.reviewed == false %}
                            <a href="/AcceptNote/{{note.id}}" class="modern-action-btn btn-publish action-link" data-loading-text="<i class='fa fa-spinner fa-spin'></i> Publishing..." title="Publish New Note">
                                <i class="fa fa-check"></i>
                                Publish Note
                            </a>
                            <a href="/DeleteNote/{{note.id}}" class="modern-action-btn btn-delete action-link" data-loading-text="<i class='fa fa-spinner fa-spin'></i> Deleting..." title="Delete Unpublished Note">
                                <i class="fa fa-trash"></i>
                                Delete Note
                            </a>
                            
                            {% elif access and note.delete_req %}
                            <a href="/AcceptNoteRemoval/{{note.id}}" class="modern-action-btn btn-delete action-link" data-loading-text="<i class='fa fa-spinner fa-spin'></i> Confirming..." title="Confirm Note Deletion">
                                <i class="fa fa-trash"></i>
                                Confirm Deletion
                            </a>
                            <a href="/DenyNoteRemoval/{{note.id}}" class="modern-action-btn btn-keep action-link" data-loading-text="<i class='fa fa-spinner fa-spin'></i> Keeping..." title="Cancel Removal Request">
                                <i class="fa fa-undo"></i>
                                Keep Note
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="content-comparison note-context" id="{{ note.id }}" data-context-type="note">
                <div class="content-side published-side">
                    <div class="side-header">
                        <h2 class="side-title">ðŸ“š Published Content</h2>
                        <p class="side-subtitle">Current live version</p>
                    </div>
                    {% if note.reviewed_fields %}
                        {% for field in note.reviewed_fields %}
                        <div class="field-item">
                            <div class="field-header">
                                <div>
                                    <div class="field-name">{{ note.note_model_fields[field.position] }}</div>
                                    {% if field.inherited %}
                                    <span class="inherited-badge" title="Inherited from base note">
                                        <i class="fa fa-link"></i>
                                        Inherited
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="note-content-display current-content"
                                 data-field-id="{{field.id}}"
                                 data-content="{{ field.content | escape }}">
                                <!-- Content populated by JS -->
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fa fa-file-o"></i>
                            <p>No published fields yet.</p>
                        </div>
                    {% endif %}
                    {% if note.reviewed_tags %}
                    <div class="field-item">
                        <div class="field-header">
                            <div class="field-name">
                                ðŸ·ï¸ Current Tags
                                {% if note.reviewed_tags|length > 6 %}
                                <button class="modern-action-btn btn-history review-action-btn-sm toggle-tags-btn" data-hidden-count="{{note.reviewed_tags|length - 6}}">
                                    +{{note.reviewed_tags|length - 6}} more
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        <div class="tag-container" id="mainTags">
                            {% for tag in note.reviewed_tags|slice(end=6) %}
                            <span class="tag-chip {% if tag.inherited %}inherited{% endif %}">
                                {% if tag.inherited %}<i class="fa fa-link tag-icon-sm"></i>{% endif %}
                                {{tag.content}}
                            </span>
                            {% endfor %}
                        </div>
                        {% if note.reviewed_tags|length > 6 %}
                        <div class="tag-container d-none" id="collapsedTags">
                            {% for tag in note.reviewed_tags|slice(start=6) %}
                            <span class="tag-chip {% if tag.inherited %}inherited{% endif %}">
                                {% if tag.inherited %}<i class="fa fa-link tag-icon-sm"></i>{% endif %}
                                {{tag.content}}
                            </span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fa fa-tags"></i>
                            <p>No published tags yet.</p>
                        </div>
                    {% endif %}
                </div>

                <div class="content-side suggestions-side">
                    <div class="side-header">
                        <h2 class="side-title">ðŸ’¡ Pending Suggestions</h2>
                        <p class="side-subtitle">Awaiting your review</p>
                    </div>
                    {% if note.note_move_decks %}
                        {% for req in note.note_move_decks %}
                        <div class="suggestion-box">
                            <div class="tag-suggestion">
                                <div class="tag-content">
                                    <i class="fa fa-folder folder-icon-blue"></i></i>
                                    <strong>Move to:</strong> {{req.path}}
                                </div>
                                {% if access %}
                                <div class="tag-actions">
                                    <button class="tag_accept_button" role="button" title="Accept Move" data-action="accept-move" data-move-id="{{req.id}}">
                                        <i class="fa fa-check"></i>
                                    </button>
                                    <button class="tag_deny_button" role="button" title="Deny Move" data-action="deny-move" data-move-id="{{req.id}}">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                    {% if note.unconfirmed_fields %}
                        {% for field_suggestion in note.unconfirmed_fields %}
                        <div class="suggestion-box">
                            <div class="field-header">
                                <div>
                                    <div class="field-name">{{note.note_model_fields[field_suggestion.position]}}</div>
                                    <a href="/commit/{{ field_suggestion.commit_id }}" class="inherited-badge inherited-link" title="View Source Commit">
                                        <i class="fa fa-link"></i> Commit #{{ field_suggestion.commit_id }}
                                    </a>
                                </div>
                                {% if access and note.reviewed %}
                                <div class="field-actions">
                                    <button data-action="accept-field" data-field-id="{{field_suggestion.id}}" class="action-btn btn-approve" title="Accept Change">
                                        <i class="fa fa-check"></i> Accept
                                    </button>
                                    <button data-action="deny-field" data-field-id="{{field_suggestion.id}}" class="action-btn btn-deny" title="Deny Change">
                                        <i class="fa fa-times"></i> Deny
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                            <div class="note-content-display diff-content"
                                data-field-id="{{ field_suggestion.id }}"
                                data-original="{{ note.reviewed_fields[field_suggestion.position].content | escape }}"
                                data-new-content="{{ field_suggestion.content | escape }}">
                                {{ field_suggestion.diff | safe }}
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                    {% if note.new_tags or note.removed_tags %}
                        {# New Tags #}
                        {% for tag in note.new_tags %}
                        <div class="suggestion-box" data-commit-id="{{ tag.commit_id }}">
                            <div class="tag-suggestion">
                                <div class="tag-content">
                                    <span class="tag-chip add">
                                        <i class="fa fa-plus-circle"></i>
                                        {{tag.content}}
                                    </span>
                                </div>
                                {% if access and note.reviewed %}
                                <div class="tag-actions">
                                    <button class="tag_accept_button" role="button" title="Accept Tag Addition" data-action="accept-tag" data-tag-id="{{tag.id}}">
                                        <i class="fa fa-check"></i>
                                    </button>
                                    <button class="tag_deny_button" role="button" title="Deny Tag Addition" data-action="deny-tag" data-tag-id="{{tag.id}}">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                        
                        {# Removed Tags #}
                        {% for tag in note.removed_tags %}
                        <div class="suggestion-box" data-commit-id="{{ tag.commit_id }}">
                            <div class="tag-suggestion">
                                <div class="tag-content">
                                    <span class="tag-chip remove">
                                        <i class="fa fa-minus-circle"></i>
                                        {{tag.content}}
                                    </span>
                                </div>
                                {% if access and note.reviewed %}
                                <div class="tag-actions">
                                    <button class="tag_accept_button" role="button" title="Accept Tag Removal" data-action="accept-tag" data-tag-id="{{tag.id}}">
                                        <i class="fa fa-check"></i>
                                    </button>
                                    <button class="tag_deny_button" role="button" title="Deny Tag Removal" data-action="deny-tag" data-tag-id="{{tag.id}}">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}

                    {# Handle case where there are no suggestions at all #}
                    {% if not note.note_move_decks and not note.unconfirmed_fields and not note.new_tags and not note.removed_tags %}
                        <div class="empty-state">
                            <i class="fa fa-lightbulb-o"></i>
                            <p>No pending suggestions for this note.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% include "layout_footer.html" %}

    <script src="/static/js/review.js"></script>
</body>
</html>