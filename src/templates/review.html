<!DOCTYPE html>
<html lang="en">
<head>
    {% include "header_template.html" %}
    <title>Review Note</title>
    
    <!-- Custom Stylesheet -->
    <link href="/static/plugins/trumbowyg/ui/trumbowyg.css" rel="stylesheet">
    <link href="/static/plugins/trumbowyg/plugins/colors/ui/trumbowyg.colors.css" rel="stylesheet">
    <link href="/static/css/commit_styling.css" rel="stylesheet">
    <script src="/static/plugins/jquery/jquery.min.js"></script>
    <style>
        .content-comparison {
            gap: 30px;
        }
    </style>
    <script>
        window.HtmlDiffUtils = {};
        window.ImageHandler = {};
        window.EditorControls = {};
        window.ApiService = {};
    </script>
    <script src="/static/js/html_diff_utils.js"></script>
    <script src="/static/js/image_handling.js"></script>
    <script src="/static/js/editor_controls.js"></script>
    <script src="/static/js/api_service.js"></script>
    <script src="/static/js/shared_ui.js"></script>
</head>
{% include "layout_header.html" %}

<body>
    <div class="main-container">
        <div class="container-fluid">
            
            {% if note.is_inherited %}
            <div class="inherited-alert">
                <i class="fa fa-link" aria-hidden="true"></i>
                <div>
                    <strong>Inherited Content:</strong> This note inherits content from a base note. Protected fields remain local. Tag removals are tracked per-subscriber.
                </div>
            </div>
            {% endif %}
            
            <div class="page-header">
                <div class="header-content">
                    <div class="header-grid">
                        <div class="header-primary">
                            <div class="header-top">
                                <h1 class="header-title">Review Note</h1>
                                <span class="status-badge {% if note.reviewed and not note.delete_req %}status-published{% elif note.delete_req %}status-removal{% else %}status-pending{% endif %}">
                                    {% if note.reviewed and not note.delete_req %}
                                        <i class="fa fa-check-circle"></i>
                                        <span>Published</span>
                                    {% elif note.delete_req %}
                                        <i class="fa fa-exclamation-triangle"></i>
                                        <span>Removal Requested</span>
                                    {% else %}
                                        <i class="fa fa-clock-o"></i>
                                        <span>New Card (Unpublished)</span>
                                    {% endif %}
                                </span>
                            </div>
                            <p class="header-subtitle">
                                <strong>Deck:</strong> {{ note.deck }}<br><strong>Last Update:</strong> {{ note.last_update }}
                            </p>
                        </div>
                        <div class="header-actions action-buttons">
                            <a href="/note_history/{{note.id}}" class="modern-action-btn btn-history" title="View full history">
                                <i class="fa fa-history"></i>
                                History
                            </a>
                            
                            {% if access and note.reviewed == false %}
                            <a href="/AcceptNote/{{note.id}}" class="modern-action-btn btn-publish" title="Publish New Note" onclick="this.classList.add('disabled'); this.style.pointerEvents='none'; this.innerHTML='<i class=\'fa fa-spinner fa-spin\'></i> Publishing...';">
                                <i class="fa fa-check"></i>
                                Publish Note
                            </a>
                            <a href="/DeleteNote/{{note.id}}" class="modern-action-btn btn-delete" title="Delete Unpublished Note" onclick="this.classList.add('disabled'); this.style.pointerEvents='none'; this.innerHTML='<i class=\'fa fa-spinner fa-spin\'></i> Deleting...';">
                                <i class="fa fa-trash"></i>
                                Delete Note
                            </a>
                            
                            {% elif access and note.delete_req %}
                            <a href="/AcceptNoteRemoval/{{note.id}}" class="modern-action-btn btn-delete" title="Confirm Note Deletion" onclick="this.classList.add('disabled'); this.style.pointerEvents='none'; this.innerHTML='<i class=\'fa fa-spinner fa-spin\'></i> Confirming...';">
                                <i class="fa fa-trash"></i>
                                Confirm Deletion
                            </a>
                            <a href="/DenyNoteRemoval/{{note.id}}" class="modern-action-btn btn-keep" title="Cancel Removal Request" onclick="this.classList.add('disabled'); this.style.pointerEvents='none'; this.innerHTML='<i class=\'fa fa-spinner fa-spin\'></i> Keeping...';">
                                <i class="fa fa-undo"></i>
                                Keep Note
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="content-comparison note-context" id="{{ note.id }}" data-context-type="note">
                <div class="content-side published-side">
                    <div class="side-header">
                        <h2 class="side-title">ðŸ“š Published Content</h2>
                        <p class="side-subtitle">Current live version</p>
                    </div>
                    {% if note.reviewed_fields %}
                        {% for field in note.reviewed_fields %}
                        <div class="field-item">
                            <div class="field-header">
                                <div>
                                    <div class="field-name">{{ note.note_model_fields[field.position] }}</div>
                                    {% if field.inherited %}
                                    <span class="inherited-badge" title="Inherited from base note">
                                        <i class="fa fa-link"></i>
                                        Inherited
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="note-content-display current-content"
                                 data-field-id="{{field.id}}"
                                 data-content="{{ field.content | escape }}">
                                <!-- Content populated by JS -->
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fa fa-file-o"></i>
                            <p>No published fields yet.</p>
                        </div>
                    {% endif %}
                    {% if note.reviewed_tags %}
                    <div class="field-item">
                        <div class="field-header">
                            <div class="field-name">
                                ðŸ·ï¸ Current Tags
                                {% if note.reviewed_tags|length > 6 %}
                                <button class="modern-action-btn btn-history" style="font-size: 0.8rem; padding: 4px 12px; margin-left: 12px;" onclick="toggleTags(this)">
                                    +{{note.reviewed_tags|length - 6}} more
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        <div class="tag-container" id="mainTags">
                            {% for tag in note.reviewed_tags|slice(end=6) %}
                            <span class="tag-chip {% if tag.inherited %}inherited{% endif %}">
                                {% if tag.inherited %}<i class="fa fa-link" style="font-size: 0.7rem;"></i>{% endif %}
                                {{tag.content}}
                            </span>
                            {% endfor %}
                        </div>
                        {% if note.reviewed_tags|length > 6 %}
                        <div class="tag-container" id="collapsedTags" style="display: none;">
                            {% for tag in note.reviewed_tags|slice(start=6) %}
                            <span class="tag-chip {% if tag.inherited %}inherited{% endif %}">
                                {% if tag.inherited %}<i class="fa fa-link" style="font-size: 0.7rem;"></i>{% endif %}
                                {{tag.content}}
                            </span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fa fa-tags"></i>
                            <p>No published tags yet.</p>
                        </div>
                    {% endif %}
                </div>

                <div class="content-side suggestions-side">
                    <div class="side-header">
                        <h2 class="side-title">ðŸ’¡ Pending Suggestions</h2>
                        <p class="side-subtitle">Awaiting your review</p>
                    </div>
                    {% if note.note_move_decks %}
                        {% for req in note.note_move_decks %}
                        <div class="suggestion-box">
                            <div class="tag-suggestion">
                                <div class="tag-content">
                                    <i class="fa fa-folder" style="margin-right: 8px; color: #0ea5e9;"></i>
                                    <strong>Move to:</strong> {{req.path}}
                                </div>
                                {% if access %}
                                <div class="tag-actions">
                                    <button class="tag_accept_button" role="button" title="Accept Move" data-action="accept-move" data-move-id="{{req.id}}">
                                        <i class="fa fa-check"></i>
                                    </button>
                                    <button class="tag_deny_button" role="button" title="Deny Move" data-action="deny-move" data-move-id="{{req.id}}">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                    {% if note.unconfirmed_fields %}
                        {% for field_suggestion in note.unconfirmed_fields %}
                        <div class="suggestion-box">
                            <div class="field-header">
                                <div>
                                    <div class="field-name">{{note.note_model_fields[field_suggestion.position]}}</div>
                                    <a href="/commit/{{ field_suggestion.commit_id }}" class="inherited-badge" style="text-decoration: none; margin-top: 8px; display: inline-block;" title="View Source Commit">
                                        <i class="fa fa-link"></i> Commit #{{ field_suggestion.commit_id }}
                                    </a>
                                </div>
                                {% if access and note.reviewed %}
                                <div class="field-actions">
                                    <button data-action="accept-field" data-field-id="{{field_suggestion.id}}" class="action-btn btn-approve" title="Accept Change">
                                        <i class="fa fa-check"></i> Accept
                                    </button>
                                    <button data-action="deny-field" data-field-id="{{field_suggestion.id}}" class="action-btn btn-deny" title="Deny Change">
                                        <i class="fa fa-times"></i> Deny
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                            <div class="note-content-display diff-content"
                                data-field-id="{{ field_suggestion.id }}"
                                data-original="{{ note.reviewed_fields[field_suggestion.position].content | escape }}"
                                data-new-content="{{ field_suggestion.content | escape }}">
                                {{ field_suggestion.diff | safe }}
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                    {% if note.new_tags or note.removed_tags %}
                        {# New Tags #}
                        {% for tag in note.new_tags %}
                        <div class="suggestion-box" data-commit-id="{{ tag.commit_id }}">
                            <div class="tag-suggestion">
                                <div class="tag-content">
                                    <span class="tag-chip add">
                                        <i class="fa fa-plus-circle"></i>
                                        {{tag.content}}
                                    </span>
                                </div>
                                {% if access and note.reviewed %}
                                <div class="tag-actions">
                                    <button class="tag_accept_button" role="button" title="Accept Tag Addition" data-action="accept-tag" data-tag-id="{{tag.id}}">
                                        <i class="fa fa-check"></i>
                                    </button>
                                    <button class="tag_deny_button" role="button" title="Deny Tag Addition" data-action="deny-tag" data-tag-id="{{tag.id}}">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                        
                        {# Removed Tags #}
                        {% for tag in note.removed_tags %}
                        <div class="suggestion-box" data-commit-id="{{ tag.commit_id }}">
                            <div class="tag-suggestion">
                                <div class="tag-content">
                                    <span class="tag-chip remove">
                                        <i class="fa fa-minus-circle"></i>
                                        {{tag.content}}
                                    </span>
                                </div>
                                {% if access and note.reviewed %}
                                <div class="tag-actions">
                                    <button class="tag_accept_button" role="button" title="Accept Tag Removal" data-action="accept-tag" data-tag-id="{{tag.id}}">
                                        <i class="fa fa-check"></i>
                                    </button>
                                    <button class="tag_deny_button" role="button" title="Deny Tag Removal" data-action="deny-tag" data-tag-id="{{tag.id}}">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}

                    {# Handle case where there are no suggestions at all #}
                    {% if not note.note_move_decks and not note.unconfirmed_fields and not note.new_tags and not note.removed_tags %}
                        <div class="empty-state">
                            <i class="fa fa-lightbulb-o"></i>
                            <p>No pending suggestions for this note.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% include "layout_footer.html" %}

    <script>
        function toggleTags(button) {
            var collapsedTags = document.getElementById("collapsedTags");
            if (collapsedTags.style.display === "none") {
                collapsedTags.style.display = "flex";
                button.innerHTML = "Show less";
            } else {
                collapsedTags.style.display = "none";
                button.innerHTML = "+{{note.reviewed_tags|length - 6}} more";
            }
        }

        function groupSuggestionsByCommit() {
            const suggestionsContainer = $('.suggestions-side');
            const suggestions = $('.suggestion-box').toArray();
            
            // Skip if no suggestions to group
            if (suggestions.length === 0) return;
            
            // Group suggestions by commit ID
            const commitGroups = {};
            
            suggestions.forEach(suggestion => {
                const $suggestion = $(suggestion);
                let commitId = null;
                
                // Try to find commit ID from field suggestions
                const commitLink = $suggestion.find('a[href*="/commit/"]');
                if (commitLink.length > 0) {
                    const href = commitLink.attr('href');
                    const match = href.match(/\/commit\/(\d+)/);
                    if (match) {
                        commitId = match[1];
                    }
                }
                
                // For tags, we need to extract from data attributes (we'll add these)
                if (!commitId) {
                    commitId = $suggestion.attr('data-commit-id');
                }
                
                // Default group for items without commit ID
                if (!commitId) {
                    commitId = 'other';
                }
                
                if (!commitGroups[commitId]) {
                    commitGroups[commitId] = [];
                }
                
                commitGroups[commitId].push($suggestion.detach());
            });
            
            // Create grouped HTML structure
            Object.keys(commitGroups).forEach(commitId => {
                const items = commitGroups[commitId];
                if (items.length === 0) return;
                
                let groupHtml;
                if (commitId === 'other') {
                    // Keep individual styling for non-commit items
                    items.forEach(item => {
                        suggestionsContainer.append(item);
                    });
                } else {
                    // Create commit group container
                    groupHtml = $(`
                        <div class="commit-group">
                            <div class="commit-header">
                                <a href="/commit/${commitId}" class="commit-badge" title="View Source Commit">
                                    <i class="fa fa-code-fork"></i> Commit #${commitId}
                                </a>
                                <span style="color: #6b7280; font-size: 0.9rem;">
                                    ${items.length} ${items.length === 1 ? 'change' : 'changes'}
                                </span>
                            </div>
                            <div class="commit-suggestions"></div>
                        </div>
                    `);
                    
                    const suggestionsList = groupHtml.find('.commit-suggestions');
                    items.forEach(item => {
                        // Convert suggestion-box to suggestion-item
                        item.removeClass('suggestion-box').addClass('suggestion-item');
                        // Remove individual commit links since they're now in the group header
                        item.find('a[href*="/commit/"]').parent().remove();
                        suggestionsList.append(item);
                    });
                    
                    suggestionsContainer.append(groupHtml);
                }
            });
            
        }

        // Initialize the shared UI components after the page loads
        $(document).ready(function() {
            SharedUI.initializePage();
            
            initiButtonFeatures();
            
            // Group suggestions by commit
            groupSuggestionsByCommit();
            
            // Enhanced spam-click protection
            $(document).on('click.protection', '.action-btn:not(.tag_accept_button):not(.tag_deny_button), [data-action="accept-field"], [data-action="deny-field"]', function(e) {
                const $btn = $(this);
                
                // If button is already disabled from previous click, prevent this click
                if ($btn.hasClass('disabled') || $btn.prop('disabled')) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
                
                // Allow the original click to proceed, then apply protection with a small delay
                setTimeout(() => {
                    // Check again - if button was already processed by original handler, don't interfere
                    if ($btn.hasClass('disabled')) {
                        return; // Already handled by existing protection
                    }
                    
                    const action = $btn.data('action') || 'processing';
                    const originalText = $btn.html();
                    
                    // Apply protection
                    $btn.addClass('disabled loading')
                        .prop('disabled', true)
                        .css('pointer-events', 'none');
                    
                    // Update button text based on action
                    const actionTexts = {
                        'accept-field': 'âœ“ Accepting...',
                        'deny-field': 'âœ— Denying...',
                        'accept-tag': 'âœ“ Accepting...',
                        'deny-tag': 'âœ— Denying...',
                        'accept-move': 'âœ“ Moving...',
                        'deny-move': 'âœ— Denying...'
                    };
                    
                    const processingText = actionTexts[action] || 'â³ Processing...';
                    
                    // For buttons with only icons, don't change text
                    if (!originalText.includes('fa-') && originalText.trim().length > 2) {
                        $btn.html(processingText);
                    }
                    
                    // Store original state for potential restoration
                    $btn.data('original-text', originalText);
                    $btn.data('click-timestamp', Date.now());
                    
                }, 10); // Small delay to let original handlers run first
                
                // Set up failsafe restore
                setTimeout(() => {
                    if ($btn.hasClass('disabled')) {
                        window.restoreButton($btn);
                    }
                }, 5000); // 5 second failsafe
            });
        });

        function initiButtonFeatures() {
            // Function to restore button state
            window.restoreButton = function($btn) {
                if ($btn && $btn.length) {
                    // Don't restore editor buttons - let them manage their own state
                    const action = $btn.data('action');
                    if (action === 'toggle-edit' || action === 'cancel-edit') {
                        return;
                    }
                    
                    $btn.removeClass('disabled loading')
                        .prop('disabled', false)
                        .css('pointer-events', '');
                    
                    const originalText = $btn.data('original-text');
                    if (originalText) {
                        $btn.html(originalText);
                    }
                    
                }
            };
            
            // Global function to restore all buttons
            window.restoreAllButtons = function() {
                $('.disabled').each(function() {
                    const $btn = $(this);
                    const action = $btn.data('action');
                    // Skip editor buttons
                    if (action !== 'toggle-edit' && action !== 'cancel-edit') {
                        window.restoreButton($btn);
                    }
                });
                console.log('ðŸ”„ All buttons restored (except editor buttons)');
            };
                        
            // Page visibility change - restore buttons when page becomes visible
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    // Check for buttons disabled longer than 10 seconds
                    $('.disabled').each(function() {
                        const $btn = $(this);
                        const action = $btn.data('action');
                        const timestamp = $btn.data('click-timestamp');
                        
                        // Skip editor buttons - they manage their own state
                        if (action === 'toggle-edit' || action === 'cancel-edit') {
                            return;
                        }
                        
                        if (timestamp && (Date.now() - timestamp > 10000)) {
                            window.restoreButton($btn);
                        }
                    });
                }
            });
            
            // Visual feedback for successful actions
            $(document).on('field:accepted field:denied tag:accepted tag:denied', function(e, itemId) {
                const isAccepted = e.type.includes('accepted');
                const $item = $(`[data-field-id="${itemId}"], [data-tag-id="${itemId}"], [data-move-id="${itemId}"]`).closest('.suggestion-box, .field-item');
                
                $item.addClass(isAccepted ? 'field-success' : 'field-error');
                
                // Show brief success/error state then fade out
                setTimeout(() => {
                    $item.fadeOut(300, function() {
                        $(this).remove();
                    });
                }, 1000);
            });
            
            // Performance monitoring
            if (window.performance && window.performance.mark) {
                window.performance.mark('review-page-interactive');
            }
            
        }
    </script>
</body>
</html>