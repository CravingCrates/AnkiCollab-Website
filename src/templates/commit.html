<!DOCTYPE html>
<html lang="en">

<head>
    {% include "header_template.html" %}

    <!-- Custom Stylesheet -->
    <link href="/static/plugins/summernote/dist/summernote.css" rel="stylesheet">
    <link href="/static/css/commit_styling.css" rel="stylesheet">
    <script src="/static/plugins/jquery/jquery.min.js"></script>

    <script>
        // Global namespace for our app
        window.HtmlDiffUtils = {};
        window.ImageHandler = {};
        window.EditorControls = {};
        window.ApiService = {};
        window.SharedUI = {};
    </script>

    <script src="/static/js/html_diff_utils.js"></script>
    <script src="/static/js/image_handling.js"></script>
    <script src="/static/js/editor_controls.js"></script>
    <script src="/static/js/api_service.js"></script>
    <script src="/static/js/shared_ui.js"></script>

</head>
{% include "layout_header.html" %}
            <!-- End Top layout-->

            <!-- row -->
            <div class="container-fluid">
                <div class="card">
                     <div class="card-body text-center">
                        <h1 class="card-title">Review Commit from {{ commit.timestamp }}</h1>
                        <p>Author: <span style="color: var(--primary);">{{ commit.user }}</span></p>
                        <p>Rationale: <span style="color: var(--secondary);">{{ commit.rationale }}</span></p>
                        <p>Current Deck: <span style="font-weight:bold">{{ commit.deck | escape }}</span></p>
                        <blockquote style="color: var(--secondary);">{{ commit.commit_info | striptags }}</blockquote>
                        {% if user and owned == true %}
                        <a href="/ApproveCommit/{{commit.id}}" class="btn mb-1 btn-success"><span class="fa fa-check"></span> Accept all</a>
                        <a href="/DenyCommit/{{commit.id}}" class="btn mb-1 btn-danger"><span class="fa fa-close"></span> Deny all</a>
                        {% endif %}
                    </div>
                </div>
                {% for note in notes %}
                <div id="{{note.id}}" class="card note-context" data-context-type="note">
                    <div class="card-header text-right">
                        <h1 class="card-title text-center">Review Note</h1>
                        <p class="text-center">Note Last Update: {{ note.last_update }}<br />Deck:  {{ note.deck | escape}}</p>

                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <a href="/review/{{note.id}}" class="btn mb-1 btn-info">
                                    <i class="icon-magnifier menu-icon"></i> Review Suggestions
                                </a>
                                {% if user and owned == true and note.reviewed == false %}
                                    <a href="/AcceptNote/{{note.id}}" class="btn mb-1 btn-success"><span class="fa fa-check"></span> Publish Note</a>
                                    <a href="/DeleteNote/{{note.id}}" class="btn mb-1 btn-danger"><span class="fa fa-close"></span> Delete Note</a>
                                {% elif user and owned == true and note.delete_req %}
                                    <a href="/AcceptNoteRemoval/{{note.id}}" class="btn mb-1 btn-danger"><span class="fa fa-close"></span> Delete Note</a>
                                    <a href="/DenyNoteRemoval/{{note.id}}" class="btn mb-1 btn-warning"><span class="fa fa-check"></span> Keep Note</a>
                                {% endif %}
                            </div>

                            <div class="action-buttons">
                                {% if user and owned == true %}
                                <button class="btn mb-1 btn-light edit-suggestion-btn" data-action="toggle-edit" data-note-id="{{note.id}}">
                                    <i class="icon-pencil menu-icon"></i>
                                    <span>Edit Suggestion</span>
                                </button>
                                <button class="btn mb-1 btn-danger abort-edit-btn" data-action="cancel-edit" data-note-id="{{note.id}}" style="display:none;">
                                    <i class="icon-close menu-icon"></i>
                                    <span>Cancel Edit</span>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <span
                            class="label label-pill {% if note.reviewed and not note.delete_req %}label-info {% elif note.delete_req %}label-danger {% else %}label-success {% endif %}px-5 py-2"
                        >
                            {% if note.reviewed and not note.delete_req %}New Suggestion
                            {% elif note.delete_req %}Removal Requested
                            {% else %}New Card
                            {% endif %}
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div {% if not note.delete_req %} class="row" {% else %} class="row justify-content-center" {% endif %}>
                            <div class="col">
                                <h5 class="text-center mb-3">Original Content</h5>
                                {% for field in note.fields %}
                                <div class="media media-reply original-side">
                                    <div class="media-body">
                                        <div class="d-sm-flex justify-content-between mb-2">
                                            <h5 class="mb-sm-0">{{notemodels[note.note_model][field.position]}}</h5>
                                        </div>
                                        <div class="note-content-display original-content"
                                             data-field-id='{{field.id}}'
                                             data-content='{{ field.reviewed_content | escape }}'>
                                             <!-- Content will be populated by JS -->
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% if not note.delete_req %}
                            <div class="col suggestion-side">
                                <h5 class="text-center mb-3">Suggested Change</h5>
                                 {% if note.move_req %}
                                 <p>Deck Change Suggestion:</p>
                                 <div class="note_tag_container suggestion-box" style="margin-bottom: 1em;">
                                     <button class="btn mb-1 btn-flat w-100" disabled>{{note.move_req.path}}</button>
                                     {% if user and owned == true %}
                                     <div class="tag_actions">
                                         <button class="tag_accept_button" role="button" data-action="accept-move" data-move-id="{{note.move_req.id}}">
                                             <i class="fa fa-check"></i>
                                         </button>
                                         <button class="tag_deny_button" role="button" data-action="deny-move" data-move-id="{{note.move_req.id}}">
                                             <i class="fa fa-times"></i>
                                         </button>
                                     </div>
                                     {% endif %}
                                 </div>
                                 {% endif %}

                                 {% if note.fields %} <p>Field Changes:</p> {% endif %}
                                 {% for field in note.fields %}
                                 <div class="media media-reply suggestion-box">
                                     <div class="media-body">
                                         <div class="d-sm-flex justify-content-between mb-2">
                                             <h5 class="mb-sm-0">{{notemodels[note.note_model][field.position]}}</h5>
                                             {% if user and owned == true and note.reviewed %}                                             
                                             <div class="media-reply__link small-badge field-actions">
                                                <span class="badge badge-pill badge-success mr-1">
                                                    <button data-action="accept-field" data-field-id="{{field.id}}" class="btn btn-xs btn-approve" title="Accept Change">
                                                        <span class="fa fa-check"></span> Accept
                                                    </button>
                                                </span>
                                                <span class="badge badge-pill badge-danger">
                                                    <button data-action="deny-field" data-field-id="{{field.id}}" class="btn btn-xs btn-deny" title="Deny Change">
                                                        <span class="fa fa-close"></span> Deny
                                                    </button>
                                                </span>
                                            </div>
                                             {% endif %}
                                         </div>
                                         <div class="note-content-display diff-content"
                                              data-field-id='{{field.id}}'
                                              data-original='{{ field.reviewed_content | escape }}'
                                              data-new-content='{{ field.content | escape }}'>
                                              {{ field.diff | safe }}
                                         </div>
                                     </div>
                                 </div>
                                 {% endfor %}

                                 {% if note.new_tags or note.removed_tags %}
                                     <hr />
                                     <p>Tag Changes:</p>
                                 {% endif %}
                                 {% for tag in note.removed_tags %}
                                 <div class="note_tag_container suggestion-box">
                                     <button class="btn mb-1 btn-flat btn-rmd-tag w-100" disabled>{{tag.content}}</button>
                                     {% if user and owned == true and note.reviewed %}
                                     <div class="tag_actions">
                                         <button class="tag_accept_button" role="button" data-action="accept-tag" data-tag-id="{{tag.id}}">
                                             <i class="fa fa-check"></i>
                                         </button>
                                         <button class="tag_deny_button" role="button" data-action="deny-tag" data-tag-id="{{tag.id}}">
                                             <i class="fa fa-times"></i>
                                         </button>
                                     </div>
                                     {% endif %}
                                 </div>
                                 {% endfor %}
                                 {% for tag in note.new_tags %}
                                 <div class="note_tag_container suggestion-box">
                                     <button class="btn mb-1 btn-flat btn-new-tag w-100" disabled>{{tag.content}}</button>
                                     {% if user and owned == true and note.reviewed %}
                                     <div class="tag_actions">
                                          <button class="tag_accept_button" role="button" data-action="accept-tag" data-tag-id="{{tag.id}}">
                                             <i class="fa fa-check"></i>
                                         </button>
                                         <button class="tag_deny_button" role="button" data-action="deny-tag" data-tag-id="{{tag.id}}">
                                             <i class="fa fa-times"></i>
                                         </button>
                                     </div>
                                     {% endif %}
                                 </div>
                                 {% endfor %}
                            </div>
                            {% endif %} <!-- end not note.delete_req -->
                        </div> <!-- end row -->
                    </div> <!-- end card-body -->
                </div> <!-- end card -->
                {% endfor %}
            </div> <!-- end container-fluid -->
        </div>
        <!--**********************************
            Content body end
        ***********************************-->

    {% include "layout_footer.html" %}

    <script src="/static/plugins/summernote/dist/summernote.min.js"></script>
    <script>
        // Initialize the shared UI components after the page loads
        $(document).ready(function() {
            SharedUI.initializePage();
        });
    </script>
</body>
</html>